<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="icon" href="{{ asset('favicon.ico') }}">
        <script src="https://kit.fontawesome.com/274d342162.js" crossorigin="anonymous"></script>
        {% block stylesheets %}
            {{ encore_entry_link_tags('app') }}
        {% endblock %}

        {% block javascripts %}
            {{ encore_entry_script_tags('app') }}
            <script src="https://js.stripe.com/clover/stripe.js"></script>

        {% endblock %}
    </head>
    <body class="frontend w-full min-h-screen flex flex-col" data-controller="cart-flash" data-cart-open="{{ app.flashes('cart_open')|length > 0 ? 'true' : 'false' }}">
    <header class="w-full px-5 bg-[#F7F7F7] h-20 fixed z-10 top-0 right-0 left-0 shadow-md shadow-blue-700">
        <nav data-controller="navbar" data-action="mouseleave->navbar#hideAllMenus" class="mx-auto w-full flex justify-between items-center gap-3 h-full">
            <div class="flex h-full items-center gap-5 font-semibold">
                <a class="my-auto h-full" href="{{ path('app_home')}}"><img src="{{ asset('uploads/logo.png') }}" alt="Logo InnovShop" class="h-full w-2xs object-cover"></a>
                <div id="categories" data-action="mouseenter->navbar#showCategoriesMenu" data-navbar-target="categoriesBtn" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white cursor-pointer">
                    Boutique
                </div>
                
                <a href="{{ path('app_contact') }}" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white cursor-pointer">Contact</a>
            </div>
            <form action="{{ path('app_products_all') }}" method="get" class="flex-1 mx-5">
                <div class="relative">
                    <input type="search" name="q" placeholder="Rechercher un produit..." value="{{ app.request.query.get('q') }}" class="w-full rounded-full border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent">
                    <button type="submit" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
            </form>
            <div class="flex justify-center items-center gap-2 my-auto text-sm font-semibold pr-5">
                <div id="account" data-action="mouseenter->navbar#showAccountMenu" data-navbar-target="accountBtn" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white cursor-pointer"><i class="fa-regular fa-user"></i>Mon compte</div>
                <div id="cart" data-action="mouseenter->navbar#showCartMenu" data-navbar-target="cartBtn" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white cursor-pointer relative">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>Panier</span>
                    {% if cartQuantity > 0 %}
                    <span class="text-xs text-center bg-blue-700 text-white rounded-3xl w-5 h-5 absolute bottom-5 left-0 m-auto">{{ cartQuantity }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Déroulé des catégories -->
            <div class="hidden fixed flex items-center gap-3 h-fit left-0 top-20 w-full shadow-md shadow-blue-700 bg-[#F7F7F7] p-5" id="categoriesMenu" data-navbar-target="categoriesMenu">
                <ul class="w-full flex justify-center gap-10 items-center text-sm">
                    <li><a href="{{ path('app_products_all') }}" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Tous les produits</a></li>
                    <li>||</li>
                    {% for category in categories %}
                        {% if category.products|length > 0 %}
                        <li><a href="{{ path('app_products_category', {id: category.id, slug: category.slug }) }}" class="p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">{{ category.name }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>

            <!-- Déroulé du panier -->
            <div id="cartMenu" data-navbar-target="cartMenu" class="hidden bg-[#F7F7F7] shadow-md shadow-blue-700 flex flex-col gap-5 fixed right-0 top-20 max-w-[500px] mx-auto p-5 rounded-bl-3xl text-black">
                <h3 class="font-semibold text-lg text-center">Mon panier</h3>
                {% if cart and cart.orderLines|length > 0 %}
                    <div class="max-h-[160px] overflow-y-auto flex flex-col gap-1">
                        {% for line in cart.orderLines %}
                            <div class="grid grid-cols-5 gap-1 items-center mx-auto text-black text-sm text-center w-full">
                                {% if (line.productVariant.product.images|length > 0) %}
                                    <img src="{{ asset('uploads/' ~ line.productVariant.product.images|first) }}" alt="{{ line.productVariant.product.title }}" class="max-h-[50px] w-full rounded-md object-cover">
                                {% else %}
                                    <img src="{{ asset('uploads/no-photo.jpg') }}" alt="Image par défaut" class="max-h-[50px] w-full rounded-md object-cover">
                                {% endif %}
                                <p class="col-span-2 text-xs">{{ line.productVariant.title }}</p>
                                <div>
                                    <p>{{ line.subtotal|number_format(2, ',', ' ') }} €</p>
                                    {% if line.quantity > 1 %}
                                        <p class="text-xs">( {{ line.quantity }} x {{ line.productVariant.price|number_format(2, ',', ' ') }} €)</p>
                                    {% endif %}
                                </div>
                                <div class="grid grid-cols-3 items-center">
                                    <form method="post" action="{{ path('app_products_remove_to_cart', {id: line.productVariant.id}) }}">
                                        <input type="hidden" name="quantity" value="1">
                                        <input type="hidden" name="redirect" value="{{ app.request.uri }}">
                                        <button class="text-black text-xs cursor-pointer">
                                            {% if line.quantity > 1 %}
                                                <i class="fa-solid fa-minus"></i>
                                            {% else %}
                                                <i class="fa-solid fa-trash"></i>
                                            {% endif %}
                                        </button>
                                    </form>
                                    <p class="text-xs text-center font-semibold text-black">{{ line.quantity }}</p>
                                    <form method="post" action="{{ path('app_products_add_to_cart', {id: line.productVariant.id}) }}">
                                        <input type="hidden" name="quantity" value="1">
                                        <input type="hidden" name="redirect" value="{{ app.request.uri }}">
                                        {% if line.quantity < line.productVariant.stock %}
                                            <button class="text-black text-xs cursor-pointer">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        {% else %}
                                            <p class="text-xs text-center">MAX</p>
                                        {% endif %}
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mx-auto font-bold text-lg">Sous-total : {{ cart.total|number_format(2, ',', ' ') }} €</div>
                {% else %}
                    <p class="text-center text-sm px-2">Votre panier est vide</p>
                {% endif %}
                <div class="mx-auto mb-5">
                    <a href="{{ path('app_user_cart') }}" class="text-blue-700 block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Voir mon panier</a>
                </div>
            </div>

            <!-- Déroulé du compte -->
            <div id="accountMenu" data-navbar-target="accountMenu" class="hidden bg-[#F7F7F7] text-blue-700 shadow-md shadow-blue-700 flex flex-col gap-5 fixed right-0 top-20 w-[300px] mx-auto rounded-bl-3xl">
                {% if not app.user %}
                    <p class="text-black text-center font-semibold mt-5">Aucun compte connecté.</p>
                    <span class="w-[50%] mx-auto border-b border-blue-700"></span>
                    <div class="mx-auto mb-5">
                        <a href="{{ path('app_login', { redirect: app.request.uri }) }}" class="block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Se connecter / S'inscrire <i class="fa-solid fa-arrow-right-to-bracket"></i></a>
                    </div>
                {% else %}
                    <p class="text-black font-semibold text-center mt-5">Bonjour {% if not app.user.firstname %}M ou Mme{% else %}{{app.user.firstName}}{% endif %} {{app.user.name}}</p>
                    <span class="w-[50%] mx-auto border-b border-blue-700"></span>
                    <div class="mx-auto">
                        <a href="{{path('app_user_profil')}}" class="block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Mon profil</a>
                    </div>
                    <div class="mx-auto">
                        <a href="{{path('app_user_orders')}}" class="block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Mes commandes</a>
                    </div>
                    {% if is_granted('ROLE_ADMIN') %}
                        <div class="mx-auto">
                        <a href="{{path('admin')}}" class="block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Dashboard Admin</a>
                        </div>
                    {% endif %}
                    <span class="w-[50%] mx-auto border-b border-blue-700"></span>
                    <div class="mx-auto mb-5">
                        <a href="{{ path('app_logout')}}" class="text-red-700 block p-2 rounded-2xl hover:bg-linear-to-r hover:from-blue-700 hover:to-sky-500 hover:text-white font-semibold text-center">Se déconnecter <i class="fa-solid fa-arrow-right-from-bracket"></i></a>
                    </div>
                    
                {% endif %}
            </div>
        </nav>
    </header>

    <main class="flex-1 mt-20 w-full mx-auto">
        {# <img src="{{ asset('uploads/fond-accueil-clair.png') }}" alt="Fond d'écran" class="opacity-50 w-full h-full object-cover fixed top-0 left-0 -z-10"> #}

        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div
                    class="mb-4 max-w-lg mx-auto flex items-center justify-between rounded-lg px-4 py-3 shadow
                    {% if type == 'success' %} bg-green-100 text-green-800
                    {% elseif type == 'error' %} bg-red-100 text-red-800
                    {% endif %}"
                >
                    <span>{{ message }}</span>
                    <button
                        onclick="this.parentElement.remove()"
                        class="ml-4 font-bold hover:opacity-70"
                    >
                        ✕
                    </button>
                </div>
            {% endfor %}
        {% endfor %}

        <div data-controller="cookies" data-cookies-target="banner" class="fixed top-20 left-0 max-w-xl inset-x-0 bg-white border border-blue-700 shadow-lg shadow-blue-700 rounded-br-lg p-5 text-sm z-50 hidden">
            <p class="mb-3">
                Ce site utilise des cookies strictement nécessaires à son fonctionnement
                (panier, session, sécurité).
                Aucun cookie de suivi ou publicitaire n'est utilisé.
            </p>

            <div class="flex justify-between items-center gap-3">
                <a href="{{ path('app_cookies_policy') }}" class="text-blue-700 hover:underline">
                    En savoir plus
                </a>

                <button data-action="click->cookies#acknowledge" class="px-4 py-2 bg-linear-to-r from-blue-700 to-sky-500 text-white rounded-full cursor-pointer hover:shadow-md hover:shadow-blue-700 font-semibold">
                    OK
                </button>
            </div>
        </div>

        {% block body %}{% endblock %}
    </main>

    <footer class="w-full z-10 bg-[#F7F7F7] text-blue-700 ring-2 ring-blue-700 flex flex-col items-center">
        <div class="grid grid-cols-2 items-center py-3 text-xs gap-3 text-center">
            <a href="{{ path('app_terms_of_service') }}" class="hover:underline mx-3">Conditions Générales de Vente</a>
            <a href="{{ path('app_privacy_policy') }}" class="hover:underline mx-3">Politique de Confidentialité</a>
            <a href="{{ path('app_cookies_policy') }}" class="hover:underline mx-3">Politique de Cookies</a>
            <a href="{{ path('app_legal_notice') }}" class="hover:underline mx-3">Mentions Légales</a>
        </div>
        <div class="font-semibold mx-auto items-center py-3 text-center text-sm">Copyright © 2026 InnovShop - Tous droits réservés</div>
    </footer>

</body>
</html>