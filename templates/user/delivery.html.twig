{% extends 'base.html.twig' %}

{% block title %}Finaliser ma commande{% endblock %}

{% block body %}
<div class="px-5 max-w-6xl mx-auto" data-controller="checkout">

    {# Flash messages #}
    {% for flash_error in app.flashes('error') %}
        <div class="alert alert-danger" role="alert">{{ flash_error }}</div>
    {% endfor %}
    {% for flash_success in app.flashes('success') %}
        <div class="alert alert-success" role="alert">{{ flash_success }}</div>
    {% endfor %}

    <h1 class="font-bold text-center text-2xl my-10">Finaliser ma commande</h1>

    <div class="grid grid-cols-2 gap-5 mx-auto my-10 w-full">

        {# ========================= Adresse de livraison ========================= #}
        <div class="flex flex-col justify-center items-center text-black text-sm shadow-lg shadow-blue-700 rounded-3xl p-5 bg-[#F7F7F7]">
            
            {% if user.addresses|length > 0 %}
                <fieldset id="deliveryAddresses" data-checkout-target="deliveryAddresses">
                    <legend class="text-center text-blue-700 text-lg font-semibold my-4">Choisir une adresse de livraison</legend>
                    {% for address in user.addresses %}
                        <label for="deliveryAddress_{{ address.id }}" class="mx-auto flex items-center gap-2 text-black my-3 p-2 rounded-lg cursor-pointer has-checked:border has-checked:border-dashed has-checked:border-sky-500">
                            <input id="deliveryAddress_{{ address.id }}" type="radio" name="selected_delivery_address" value="{{ address.id }}" data-checkout-target="selectedDeliveryAddress" {% if address.deliveryDefault %}checked{% endif %}>
                            <div>
                                {% if address.deliveryDefault %}
                                    <p class="text-xs text-green-700 italic">Adresse par défaut</p>
                                {% endif %}
                                <div class="flex flex-wrap gap-2">
                                    <p class="font-semibold">{{ address.name }} {{ address.firstName }} : </p>
                                    <p>{{ address.address }}</p>
                                    <p>{{ address.postalCode }} {{ address.city|upper }}</p>
                                    {% if address.phone %}
                                        <p>, {{ address.phone }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    {% endfor %}
                </fieldset>
            {% endif %}

            <button type="button" id="showDeliveryForm" data-checkout-target="showDeliveryForm" data-action="click->checkout#showDeliveryFormAction" class="block bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black text-white text-sm font-semibold rounded-3xl p-2 mx-auto mt-5 w-fit cursor-pointer">
                Ajouter une nouvelle adresse de livraison
            </button>

            {# Formulaire deliveryForm #}
            <div class="hidden" id="deliveryFormContainer" data-checkout-target="deliveryFormContainer">
                <h2 class="text-center text-blue-700 text-lg font-semibold my-4">Nouvelle adresse de livraison</h2>
                <div class="flex flex-col max-w-xl mx-auto rounded-2xl items-center py-4 space-y-4 font-semibold mb-10">
                    {{ form_start(deliveryForm, {attr: {class: 'w-full'}}) }}
                        <div class="grid grid-cols-2 gap-5 items-center mx-5">
                            {{ form_label(deliveryForm.name, 'Nom*') }}
                            {{ form_widget(deliveryForm.name, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.name) }}

                            {{ form_label(deliveryForm.firstName, 'Prénom*') }}
                            {{ form_widget(deliveryForm.firstName, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.firstName) }}

                            {{ form_label(deliveryForm.address, 'Adresse*') }}
                            {{ form_widget(deliveryForm.address, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.address) }}

                            {{ form_label(deliveryForm.postalCode, 'Code postal*') }}
                            {{ form_widget(deliveryForm.postalCode, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.postalCode) }}

                            {{ form_label(deliveryForm.city, 'Ville*') }}
                            {{ form_widget(deliveryForm.city, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.city) }}

                            {{ form_label(deliveryForm.phone, 'Téléphone') }}
                            {{ form_widget(deliveryForm.phone, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(deliveryForm.phone) }}

                            {{ form_label(deliveryForm.deliveryDefault, 'Définir comme adresse de livraison par défaut ?') }}
                            <div class="items-left">
                                {{ form_widget(deliveryForm.deliveryDefault) }}
                            </div>
                            {{ form_errors(deliveryForm.deliveryDefault) }}
                        </div>
                        <button class="block bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black text-white text-sm rounded-3xl p-2 mx-auto mt-5 w-fit cursor-pointer" type="submit">
                            Valider
                        </button>
                        <p class="text-xs m-3">* Champs obligatoires</p>
                    {{ form_end(deliveryForm) }}
                </div>
                <button type="button" id="hideDeliveryForm" data-checkout-target="hideDeliveryForm" data-action="click->checkout#hideDeliveryFormAction" class="block bg-red-700 hover:bg-red-500 text-white text-sm font-semibold rounded-3xl p-2 mx-auto mb-5 w-fit cursor-pointer">
                    Annuler
                </button>
            </div>
        </div>

        {# ========================= Adresse de facturation ========================= #}
        <div class="flex flex-col justify-center items-center text-black text-sm shadow-lg shadow-blue-700 rounded-3xl p-5 bg-[#F7F7F7]">
            <div class="flex items-center gap-2 mb-5">
                <input type="checkbox" name="sameAsDelivery" id="sameAsDelivery" data-checkout-target="sameAsDelivery" data-action="change->checkout#sameAsDeliveryAction" checked>
                <label for="sameAsDelivery" class="text-blue-700 font-semibold cursor-pointer">Utiliser la même adresse pour la facturation</label>
            </div>

            {% if user.addresses|length > 0 %}
                <fieldset id="billingAddresses" class="hidden" data-checkout-target="billingAddresses">
                    <legend class="text-center text-blue-700 text-lg font-semibold my-4">Choisir une adresse de facturation</legend>
                    {% for address in user.addresses %}
                        <label for="billingAddress_{{ address.id }}" class="mx-auto flex items-center gap-2 text-black my-3 p-2 rounded-lg cursor-pointer has-checked:border has-checked:border-dashed has-checked:border-sky-500">
                            <input id="billingAddress_{{ address.id }}" type="radio" name="selected_billing_address" value="{{ address.id }}" data-checkout-target="selectedBillingAddress" {% if address.billingDefault %}checked{% endif %}>
                            <div>
                                {% if address.billingDefault %}
                                    <p class="text-xs text-green-700 mb-2">Adresse par défaut</p>
                                {% endif %}
                                <div class="flex flex-wrap gap-2">
                                    <p class="font-semibold">{{ address.name }} {{ address.firstName }} : </p>
                                    <p>{{ address.address }}</p>
                                    <p>{{ address.postalCode }} {{ address.city|upper }}</p>
                                    {% if address.phone %}
                                        <p>, {{ address.phone }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                    {% endfor %}
                </fieldset>
            {% endif %}

            <button type="button" id="showBillingForm" data-checkout-target="showBillingForm" data-action="click->checkout#showBillingFormAction" class="hidden block bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black text-white text-sm font-semibold rounded-3xl p-2 mx-auto mt-5 w-fit cursor-pointer">
                Ajouter une nouvelle adresse de facturation
            </button>

            <div class="hidden" id="billingFormContainer" data-checkout-target="billingFormContainer">
                <h2 class="text-center text-blue-700 text-lg font-semibold my-4">Nouvelle adresse de facturation</h2>
                <div class="flex flex-col max-w-xl mx-auto rounded-2xl items-center py-4 space-y-4 font-semibold mb-10">
                    {{ form_start(billingForm, {attr: {class: 'w-full'}}) }}
                        <div class="grid grid-cols-2 gap-5 items-center mx-5">
                            {{ form_label(billingForm.name, 'Nom*') }}
                            {{ form_widget(billingForm.name, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(billingForm.name) }}

                            {{ form_label(billingForm.firstName, 'Prénom*') }}
                            {{ form_widget(billingForm.firstName, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(billingForm.firstName) }}

                            {{ form_label(billingForm.address, 'Adresse*') }}
                            {{ form_widget(billingForm.address, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(billingForm.address) }}

                            {{ form_label(billingForm.postalCode, 'Code postal*') }}
                            {{ form_widget(billingForm.postalCode, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(billingForm.postalCode) }}

                            {{ form_label(billingForm.city, 'Ville*') }}
                            {{ form_widget(billingForm.city, {attr: {class: 'mt-1 block w-full bg-white rounded-md text-black px-2 border border-blue-700'}}) }}
                            {{ form_errors(billingForm.city) }}

                            {{ form_label(billingForm.billingDefault, 'Définir comme adresse de facturation par défaut ?') }}
                            <div class="items-left">
                                {{ form_widget(billingForm.billingDefault) }}
                            </div>
                            {{ form_errors(billingForm.billingDefault) }}
                        </div>
                        <button class="block bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black text-white text-sm rounded-3xl p-2 mx-auto mt-5 w-fit cursor-pointer" type="submit">
                            Valider
                        </button>
                        <p class="text-xs m-3">* Champs obligatoires</p>
                    {{ form_end(billingForm) }}
                </div>
                <button type="button" id="hideBillingForm" data-checkout-target="hideBillingForm" data-action="click->checkout#hideBillingFormAction" class="block bg-red-700 hover:bg-red-500 text-white text-sm font-semibold rounded-3xl p-2 mx-auto mb-5 w-fit cursor-pointer">
                    Annuler
                </button>
            </div>

        </div>
    </div>

    {# ========================= Formulaire final pour valider la commande ========================= #}
    <form method="post" action="{{ path('app_user_cart_valid') }}" class="flex justify-between items-center w-full max-w-6xl mx-auto my-10">
        <input type="hidden" name="selected_delivery_address" id="finalDeliveryAddress" data-checkout-target="finalDeliveryAddress" value="{{ defaultDeliveryAddress ? defaultDeliveryAddress.id : '' }}">
        <input type="hidden" name="selected_billing_address" id="finalBillingAddress" data-checkout-target="finalBillingAddress" value="{{ defaultBillingAddress ? defaultBillingAddress.id : '' }}">

        <a href="{{ path('app_user_cart') }}" class="text-blue-700 text-sm font-medium hover:underline">
            <i class="fa-solid fa-circle-arrow-left"></i> Revenir au panier
        </a>

        <button type="submit" class="bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black text-white text-lg font-semibold rounded-3xl p-2 m-2 cursor-pointer">
            Passer au paiement <i class="fa-solid fa-circle-arrow-right"></i>
        </button>
    </form>

</div>
{% endblock %}