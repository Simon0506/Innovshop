{% extends 'base.html.twig' %}

{% block title %}Mes commandes{% endblock %}

{% block body %}
    <h1 class="font-bold text-center text-2xl my-10">Mes commandes</h1>
    <div class="mx-auto max-w-4xl px-5 bg-[#F7F7F7] rounded-3xl shadow-lg shadow-blue-700 border border-sky-500 mb-10">
        {% if orders|length > 0 %}
        <div class="w-full mx-auto text-sm">
            {% for order in orders %}
                <div class="flex flex-col gap-3 text-black {% if order != orders|first %}border-t border-sky-500{% endif %} w-full p-5">
                    <div class="flex justify-between items-center text-lg font-bold">
                        <p>Commande n°{{ order.numero }} du {{ order.date|format_date('long') }}</p>
                        {% if order.status == statusPaid %}
                            <p class="text-blue-700 p-2">{{ order.status }} <i class="fa-solid fa-check"></i></p>
                        {% elseif order.status == statusDelivered %}
                            <p class="text-green-700 p-2">{{ order.status }} <i class="fa-solid fa-truck"></i></p>
                        {% endif %}
                    </div>
                    <div class="grid grid-cols-4 gap-5 items-start w-full">
                        <div class="col-span-3 flex flex-col gap-5 px-5">
                            <p class="font-semibold underline underline-offset-4">Contenu de la commande : <span class="font-bold text-md">{{ order.productsNumber }} article{% if order.productsNumber > 1 %}s{% endif %}</span></p>
                            <div class="flex flex-col items-start gap-1">
                                {% set first = groups[order.id]|first %}
                                <div class="flex items-center gap-5 my-2 w-full">
                                    {% if (first.product.images|length > 0)%}
                                        <img src="{{ asset('uploads/' ~ first.product.images|first) }}" alt="{{ first.product.title }}" class="w-20 h-20 rounded-2xl overflow-hidden border border-sky-500 object-cover">
                                    {% else %}
                                        <img src="{{ asset('uploads/no-photo.jpg') }}" alt="Image par défaut" class="w-20 h-20 rounded-2xl overflow-hidden border border-sky-500 object-cover">
                                    {% endif %}
                                    <div class="flex flex-col gap-1 flex-1">
                                        {% for group in groups[order.id] %}
                                            {% for line in group.orderLines %}
                                                <div class="flex justify-between items-center text-xs {% if group == groups[order.id]|first and line == group.orderLines|first %}border-none{% else %} border-dotted border-t border-sky-500 pt-1{% endif %}">
                                                    <p>{{ line.productVariant.title }}</p>
                                                    <p class="font-semibold">{{ line.subtotal|number_format(2, ',', ' ') }} €</p>
                                                </div>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <p class="text-lg font-bold border-t border-sky-500 w-full pt-2">TOTAL : {{ order.total|number_format(2, ',', ' ')}} €</p>
                        </div>
                        <div class="py-2">
                            <div class="flex flex-col gap-5 items-center justify-center font-semibold text-md">
                                <a href="{{ path('app_user_order_detail', {id: order.id}) }}" class="py-2 px-5 text-center w-full rounded-2xl text-white bg-linear-to-t from-sky-500 to-blue-700 hover:shadow-md hover:shadow-black">Voir le détail</a>
                                {% if order.status == statusPaid %}
                                <form action="{{ path('app_user_order_cancel', {id: order.id}) }}" method="post" data-controller="confirm" data-confirm-message-value="Êtes-vous sûr de vouloir annuler cette commande ?" class="w-full">
                                    <input type="hidden" name="_token" value="{{ csrf_token('cancel-order-' ~ order.id) }}">
                                    <button type="submit" data-action="confirm#submit" class="py-2 px-5 text-center w-full rounded-2xl text-white bg-red-700 hover:shadow-md hover:shadow-black cursor-pointer">Annuler la commande</button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
            <p class="text-black text-sm text-center">Vous n'avez aucune commande pour le moment</p>
        {% endif %}
        
    </div>
{% endblock %}
